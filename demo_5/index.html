<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Rocks Demo</title>
    <script src="demo%20snippets/phaser.js"></script>
    <script src="https://graspablemath.com/shared/libs/gmath/gm-inject.js"></script>
    <script src = "js/graspableMathLogic.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">


var game = new Phaser.Game(800, 600, Phaser.AUTO, 'game-div', { preload: preload, create: create, update: update});
//var g_eggs = [];  // global array to hold all eggs
var g_rocks = [];	// global array to hold all rocks
var g_hitCount = [];
var g_eggTextArray = [];
var currentEggIndex = -1;
var eggHitAlready = false;

 
function preload() {
    game.load.image('rock', 'assets/rock.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('fragment', 'assets/rock_fragment.png');
    
    //change width of frame later
    //game.load.spritesheet('egg', 'assets/egg_spritesheet.png',103,126);
    game.load.atlasJSONHash('egg', 'assets/eggSpritesheet.png','assets/eggSpritesheet.json');
    
    
    game.load.spritesheet('hatchling', 'assets/hatchling_run.png', 139, 89);
    game.load.image('star', 'assets/star.png');
//    game.load.image('dinoMom', 'assets/dinoMom.png');
    game.load.atlasJSONHash('dino', 'assets/dino.png','assets/dino.json');
    game.load.image('sky', 'assets/sky.png');
    
    game.load.spritesheet('button', 'assets/button.png', 120, 40);
    
    //background music
    game.load.audio('bg_music',['assets/bg_music.mp3']);
    
    game.load.image('restart', 'assets/restart.png');
    
}
    
var rock;
var platforms;
var hatchling; //hatchling
var score = 0;
var scoreText;
var expressionTextStyle;
var rockText;
var playing;
var music;


var gameOverText;
var scoreBase = 20;
var starNumber = 0;
var starPostion = 0;
    
    
//Testing group feature
var eggsGroup;


function create() {
   game.add.sprite(0, 0, 'sky');
   game.physics.startSystem(Phaser.Physics.ARCADE);
   platforms = game.add.group();
   platforms.enableBody = true;
   var ground = platforms.create(0, game.world.height - 64, 'ground');
   ground.scale.setTo(2,2);
   ground.body.immovable = true;

    //Dino mom  
    var dino = game.add.sprite(600,game.world.height-150, 'dino');
    var move = dino.animations.add('move',['2.png','3.png','4.png','5.png'],24,true);
    dino.animations.play('move', 10, true);
    game.add.tween(dino).to({y: 300}, 2400, Phaser.Easing.Bounce.InOut, true);

    
      
    
    //  The score
    scoreText = game.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });
    
   
    //start button
    startButton = game.add.button(game.world.width*0.5, game.world.height*0.5, 'button', startGame, this, 1, 0, 2);
    startButton.anchor.set(0.5);
   
    //music 
    music = game.add.audio('bg_music');
    
    CreateEggs(4); 
    

    
    
}

function startGame() {
    startButton.destroy();
    CreateRocks(1);
    expressionTextStyle = { font: "20px Arial", fill: "#ff0044", wordWrap: true, wordWrapWidth: rock.width, align: "center"};
    playing = true;
    //eggText.visible = true;
    music.play();
}
    
function gameOver() {
    playing = false;
    scoreText.destroy();
    gameOverText = game.add.text( game.world.width*0.5, game.world.height*0.5 - 40, 'Game is over!!! Score:' + score, { fontSize: '22px', fill: '#000' });
    endStar();
    restartButton = game.add.button(game.world.width*0.5, game.world.height*0.5 + 20, 'restart', restartGame, game, 1, 0, 2);
    restartButton.anchor.set(0.5);
    music.stop();
}
    
function restartGame(){
    console.log("Game Restart");
    game.state.restart();
}
    
function endStar() {
    while (score > 0){
       game.add.sprite(game.world.width*0.5 + starPostion, game.world.height*0.5 - 80, 'star');
        starPostion = starPostion + 20;
        score = score - scoreBase; 
        starNumber++;
        if (starNumber == 5){
            break;
        }
    }
}


function update() {
    game.physics.arcade.collide(eggsGroup, platforms);
    
    //  Checks to see if the rock overlaps with any of the eggs, if it does call the hatchEgg function
    game.physics.arcade.overlap(rock, eggsGroup, hatchEgg, null, this);
    if(playing){
        rockText.x = Math.floor(rock.x + rock.width / 2);
        rockText.y = Math.floor(rock.y + rock.height / 2);
        //update egg equation on the egg
        for(i = 0 ; i < eggsGroup.children.length ; i++){
            g_eggTextArray[i].x = Math.floor(eggsGroup.children[i].x + eggsGroup.children[i].width / 2);
            g_eggTextArray[i].y = Math.floor(eggsGroup.children[i].y + eggsGroup.children[i].height / 2);
            g_eggTextArray[i].visible = true;
        }
    }else{
        if(rock != undefined){
            rock.kill();
            rockText.kill();
        }
        
    }

}


function hatchEgg(rock, egg_tt){
    eggHitAlready = true; 
    //to update this variable once we have an array of hits
    //var hitEggIndex = g_eggs.indexOf(eggSprite);
    console.log(egg_tt);
    console.log(eggsGroup);
    var hitEggIndex = eggsGroup.getIndex(egg_tt);
    console.log("Egg hit index");
    console.log(hitEggIndex);
    
    var hits = ++g_hitCount[hitEggIndex];
    
    rockBurst();
    
    if(hits!=3)
        CreateRocks(1);
    switch(hits){
        case 1 : egg_tt.tint = 0x00ff00;
                egg_tt.animations.play('wiggle');
                break;
        case 2 : egg_tt.tint = 0xff0000;
                egg_tt.animations.play('wiggle');
                break
        case 3 :  egg_tt.animations.play('hatch', 2, false);
                 break;
            
    }
        

}
    
function rockBurst() {
    
    
     //burst emitter for rocks
    var rock_emitter = game.add.emitter(0, 0, 100);

    rock_emitter.makeParticles('star');
    rock_emitter.gravity = 0;

    rock_emitter.x = rock.x;
    rock_emitter.y = rock.y;
    
    //explode / milliseconds before particle disappear/ doesn't matter/ number of particles emitted at a time
    rock_emitter.start(true, 2000, null, 5);
    
    rock.kill();
    rockText.kill();
    
    //  And 2 seconds later we'll destroy the emitter
    game.time.events.add(2000, destroyObject, this, rock_emitter);
    

}
    
function runToMom(egg_x){
    var hatchling = game.add.sprite(egg_x,game.world.height-150, 'hatchling');
    hatchling.anchor.setTo(0.5, 0.5);
    //hatchling.scale.setTo(2, 2);
    hatchling.animations.add('run');
    hatchling.animations.play('run', 10, true); 
    // params are: properties to tween, time in ms, easing and auto-start tweenthis.
    var runningDinoTween = game.add.tween(hatchling).to({x: 600, y: game.world.height-150}, 3000, Phaser.Easing.Quadratic.InOut, true);
    runningDinoTween.onComplete.addOnce(stopDino, this,hatchling);  

}
    
function stopDino(hatchling){
    //  This method will reset the frame to frame 1 after stopping
    hatchling.animations.stop(null, true);
}

function destroyObject(obj) {
    if(obj != undefined)
        obj.destroy();
}

function CreateEggs(numEggs){
	
	 //  Eggs group
    eggsGroup = game.add.group();

    //  We will enable physics for any star that is created in this group
    eggsGroup.enableBody = true;
    var egg_y = game.world.height - 150;
    var egg_x = 32;
    //  Here we'll create 4 of them evenly spaced apart
    for (var i = 0; i < numEggs; i++)
    {
        var egg = eggsGroup.create(egg_x, egg_y, 'egg');

        //  Let gravity do its thing
        egg.body.gravity.y = 300;
        egg.body.bounce.y =  0.2; 
        egg.body.collideWorldBounds = true;
        
        var hatchAnimation = egg.animations.add('hatch',['egg1.png','egg2.png','egg3.png','egg4.png','egg5.png','egg6.png','egg7.png','egg8.png']);
        egg.animations.add('wiggle',['wiggle1.png','wiggle2.png','wiggle3.png','wiggle2.png','wiggle4.png','wiggle5.png','wiggle4.png','egg1.png'],24,false);
        hatchAnimation.onComplete.add(hatchAnimationStopped, this);
        egg_x += 120;
        g_hitCount.push(0);
        
        //place equation on egg
        var equation = createEggEquation();
        expressionTextStyle = { font: "20px Arial", fill: "#ff0044", wordWrap: true, wordWrapWidth: egg.width, align: "center"};
        var eggText = game.add.text(Math.floor(egg.x + egg.width / 2), Math.floor(egg.y + egg.height / 2), equation, expressionTextStyle);
        eggText.anchor.set(0.5);
        eggText.visible = false;
        g_eggTextArray.push(eggText);
        
        //add click event to egg
        egg.inputEnabled = true;
        egg.events.onInputDown.add(populateSolveEqCanvas, this, egg);
  
    }

}

    

function populateSolveEqCanvas(selectedEgg){ 
    //currentEggIndex = getSelectedEggIndex(selectedEgg);
    currentEggIndex = eggsGroup.getIndex(selectedEgg);
    if(currentEggIndex != -1){
        clearGMCanvas();
        solveEqCanvas.model.createElement('derivation', { eq: g_eggTextArray[currentEggIndex].text, pos: { x: 'center', y: 50 } });
    }
}
    

function getSelectedEggIndex(selectedEgg){
    var index = -1;
    for(i = 0 ; i < g_eggs.length ; i++){
        if(selectedEgg == g_eggs[i]){    
            index = i;
            break;
        }
    }
    return index;
}
    
    
function CreateRocks(numRocks){
	var _y = 200, _x = 50;
	for(var i=0; i < numRocks; i++){       
        rock = game.add.sprite(300,40,'rock');
        game.physics.arcade.enable(rock);
        rock.body.gravity.y = 5;
        rock.body.collideWorldBounds = true;
        rock.scale.x = 0.15;
        rock.scale.y = 0.15;
        expressionTextStyle = { font: "20px Arial", fill: "#ff0044", wordWrap: true, wordWrapWidth: rock.width, align: "center"};
        rockText = game.add.text(0, 0, getMatchEquationOnRock(), expressionTextStyle);
        rockText.anchor.set(0.5);
        g_rocks.push(rock);
     
	}
    
    
   
}
    
function hatchAnimationStopped(eggSprite, animation) {
    //remove the value from hit counter
    var eggIndex = eggsGroup.getIndex(eggSprite);
    g_hitCount.splice(eggIndex);
    
    //get x position for egg to hatch
    var egg_x = eggSprite.x;
    //kill the egg 
    eggSprite.kill();
    destroyObject(g_eggTextArray[eggIndex]);
    runToMom(egg_x);
    gameOver();

} 

    
var eqList = new Array();
var numEqSolved = 1;
//GM Code
loadGM(initCanvas, { version: '0.12.6' });
function initCanvas() {
    
    //Canvas1 is for Equation Solving
    //Canvas2 is for Pattern Matching
    solveEqCanvas = new gmath.Canvas('#gmath1-div', {use_toolbar: false, vertical_scroll: false });
    matchExpCanvas = new gmath.Canvas('#gmath2-div', {use_toolbar: false, vertical_scroll: false });
    matchExpCanvas.model.createElement('derivation', { eq: g_parsedCanvasExpression, pos: { x: 200, y: 50 } });
    
    showHide(document.getElementById('gmath1-div'));
    
    matchExpCanvas.model.on('el_changed', function(evt) {
		
		if (evt.last_eq == g_equation){
            numEqSolved++;
            console.log("Solved");
            rockBurst();
            CreateRocks(1);
            //Add and update the score
            score += 10;
            scoreText.text = 'Score: ' + score;			
			if(numEqSolved % 3 == 0){
                console.log("Attempting to clear canvas");
                clearGMCanvas();
                rock.visible =false;
                rockText.visible =false;
                rock.body.gravity.y = 0;
                //canvas1.model.createElement('derivation', { eq: generateRandomExp(), pos: { x: 100, y: 50 } });
                showHide(document.getElementById('gmath1-div'));
				showHide(document.getElementById('gmath2-div'));
            }

		}
	});
    
  
    
    solveEqCanvas.model.on('el_changed', function(evt) {
         console.log(!isNaN(evt.last_eq.slice(2)),evt.last_eq.slice(2));
	    // condition to check if equation is solved
        if (evt.last_eq.startsWith("x=") && !isNaN(evt.last_eq.slice(2))){
            score += 50;
            scoreText.text = 'Score: ' + score;
            var egg = eggsGroup.children[currentEggIndex];
            egg.animations.play('hatch', 2, false);
            setTimeout(showHide(document.getElementById('gmath1-div')), 3000);
            setTimeout(showHide(document.getElementById('gmath2-div')), 3000);
            rock.body.gravity.y = 5;
            rock.visible =true;
            rockText.visible =true;
            currentEggIndex = -1;
        }
    });
}
    
 

 
</script>


<div id='game-div'></div>
<div class = 'row'>
<div id='gmath1-div' class="col-sm-4" ></div>
<div id='gmath2-div' class="col-sm-4" ></div>
</div>

</body>
</html>

