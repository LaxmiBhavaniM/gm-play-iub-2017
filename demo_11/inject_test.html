/* Options:
 *   - version (no default, need to specify)
 *   - basePath (default is 'https://graspablemath.com/')
 *   - excludePatterns (default is [])
 *   - canvas_css_version (default is 0, set to force refresh)
 */
var loadGM = function(callback, options) {
  if (!options) options = {};
  if (!options.basePath) options.basePath = 'https://graspablemath.com/';
  if (!options.excludePatterns) options.excludePatterns = [];
  if (!options.canvas_css_version) options.canvas_css_version = '0';
  var loadScripts = function(urls, callback) {
    if (!options.basePath) options.basePath = '../';
    var filtered_urls = urls.filter(excludeFilter);
    var number_of_scripts = filtered_urls.length;
    filtered_urls.forEach(function(src, idx) {
      var script = document.createElement('script');
      script.type = "text/javascript";

      if (callback && (idx === number_of_scripts - 1)) {
        if (script.readyState){  //IE
          script.onreadystatechange = function(){
            if (script.readyState == "loaded" ||
              script.readyState == "complete"){
              script.onreadystatechange = null;
              if (callback) callback();
            }
          };
        } else {  //Others
          script.onload = function(){
            if (callback) callback();
          };
        }
      }

      script.src = src;
      script.async = false;
      document.head.appendChild(script);
    });
  }

  var loadCSS = function(urls) {
    urls.filter(excludeFilter)
      .forEach(function(url) {
        var link = document.createElement("link")
        link.rel = "stylesheet";
        link.href = url;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
  }

  function excludeFilter(url) {
    return options.excludePatterns.every(function(ex) {
      return url.indexOf(ex) === -1;
    });
  }

  function versionCompare(v1, v2) {
    if (v1 === 'latest' || v1 === '' || !v1) return 1;
    var v1parts = v1.split('.')
      , v2parts = v2.split('.');

    var isValid = function(str) { return /^\d+$/.test(str) }

    if (!v1parts.every(isValid) || !v2parts.every(isValid)) return NaN;

    while (v1parts.length < v2parts.length) v1parts.push("0");
    while (v2parts.length < v1parts.length) v2parts.push("0");

    v1parts = v1parts.map(Number);
    v2parts = v2parts.map(Number);

    for (var i = 0; i < v1parts.length; ++i) {
        if (v1parts[i] > v2parts[i]) return 1;
        if (v1parts[i] < v2parts[i]) return -1;
    }

    return 0;
  }

  function getVersionStr(str) {
    if (!str) return '';
    if (str.match("[0-9]+\\.[0-9]+\\.[0-9]")) {
      return '-' + str;
    } else if (str === 'latest') {
      return '';
    } else {
      console.warn('Unsupported verson string format: "' + version_str + '".');
      console.info('Loading the latest version of Graspable Math.');
      return '';
    }
  }

  var core_version = options.core_version || options.version || 'latest'
    , core_version_str = getVersionStr(core_version)
    , ui_version = options.ui_version || 'latest'
    , ui_version_str = getVersionStr(ui_version);

  function on_loaded() {
    gmath.ui.resource_path = options.basePath + 'shared/';
    console.info('Loaded gmath v' + gmath.version + '.');
    if (gmath.ui && gmath.ui.version) {
      console.info('Loaded gmath-canvas v' + gmath.ui.version + '.');
    }
    if (options && options.loadScripts) loadScripts(options.loadScripts, callback);
    else if (callback) callback();
  }

  // before 0.10.0, load gmath-canvas.min.js as a separate library
  if (versionCompare(core_version, '0.10.0') === -1) {
    loadCSS( [ options.basePath + "shared/fonts/fonts.css"
           , options.basePath + "shared/css/canvas.css"
           , options.basePath + "shared/libs/bootstrap-3.3.4-dist/css/bootstrap.min.css"
           , options.basePath + "shared/libs/bootstrap-3.3.4-dist/css/no-btn-focus.css"
           , options.basePath + "shared/libs/mathquill/mathquill.css" ] );
    loadScripts( [ options.basePath + "shared/libs/d3/d3.min.js"
               , options.basePath + "shared/libs/geom.js/geom-partial.min.js"
               , options.basePath + "shared/libs/gmath/gmath"+core_version_str+".min.js"
               , options.basePath + "shared/libs/gmath/gmath-canvas"+ui_version_str+".min.js"
               , options.basePath + "shared/libs/jquery/jquery-2.1.0.min.js"
               , options.basePath + "shared/libs/mathquill/mathquill.min.js"
               , options.basePath + "shared/libs/algebrite/algebrite.min.js"
               , options.basePath + "shared/libs/bootstrap-3.3.4-dist/js/bootstrap.min.js" ]
             , on_loaded);
  }
  // before 0.11.0, load geom, algebrite & mathquill separately
  else if (versionCompare(core_version, '0.11.0') === -1) { // version prior to 0.11.0
    loadCSS( [ options.basePath + "shared/fonts/fonts.css"
           , options.basePath + "shared/css/canvas.css"
           , options.basePath + "shared/libs/bootstrap-3.3.4-dist/css/bootstrap.min.css"
           , options.basePath + "shared/libs/bootstrap-3.3.4-dist/css/no-btn-focus.css"
           , options.basePath + "shared/libs/mathquill/mathquill.css" ] );
    loadScripts( [ options.basePath + "shared/libs/d3/d3.min.js"
               , options.basePath + "shared/libs/geom.js/geom-partial.min.js"
               , options.basePath + "shared/libs/gmath/gmath"+core_version_str+".min.js"
               , options.basePath + "shared/libs/jquery/jquery-2.1.0.min.js"
               , options.basePath + "shared/libs/mathquill/mathquill.min.js"
               , options.basePath + "shared/libs/algebrite/algebrite.min.js"
               , options.basePath + "shared/libs/bootstrap-3.3.4-dist/js/bootstrap.min.js" ]
             , on_loaded);
  }
  // starting with version 0.11.0, geom, algebrite & mathquill are in the package
  else {
    loadCSS([ options.basePath + "shared/fonts/fonts.css"
            , options.basePath + "shared/css/canvas.css?ver=" + options.canvas_css_version
            , options.basePath + "shared/libs/bootstrap-3.3.7-dist/css/bootstrap.min.css"
            , options.basePath + "shared/libs/bootstrap-3.3.7-dist/css/no-btn-focus.css"
            ]);
    loadScripts( [ options.basePath + "shared/libs/d3/d3.min.js"
               , options.basePath + "shared/libs/jquery/jquery-3.1.0.min.js"
               , options.basePath + "shared/libs/bootstrap-3.3.7-dist/js/bootstrap.min.js" ]
               , function() {
                 loadScripts( [options.basePath + "shared/libs/gmath/gmath"+core_version_str+".min.js"]
                           , on_loaded);
               });
  }
}
